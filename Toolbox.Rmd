---
title: "Exploring Alchohol Consumption Data"
author: "Xiangxi Kong"
date: "26 April 2017"
output: 
  html_document: 
    fig_height: 7
    fig_width: 10
    mainfont: Arial
    theme: paper
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Project Overview
The dataset I chose were obtained by a survey of students from portuguese language courses in secondary school, which contains a lot of interesting social, gender and study information about students. You can use it for some EDA or try to predict students final grade. The goal for this analysis is to create a model that can predict which students are consuming dangerous amounts of alcohol. We will first perform an analysis on all of the features, then use this information to build our model. eamines whether alcohol consumption has any predictive power over student average grades. I am also interested in learning what other features may be important predictors of student grades.
Datasource: 
[kaggle: Student Alcohol Consumption dataset](https://www.kaggle.com/dmitriy19/student-alcohol-consumption)

## Data Prepration

```{r message=FALSE}
library(ggplot2)
library(plyr)
library(dplyr)
library(plotly)
library(knitr)
library(gridExtra)
library(gridExtra)
library(alluvial)
library(waffle)
library(extrafont)
dataset <- read.csv('https://query.data.world/s/1cea8cn4qr1dj4v46kw8ehhhu',header=T,sep=",",stringsAsFactors = F)
str(dataset)
sapply(dataset, function(x) sum(is.na(x)))
```
The data set consist of 33 variables and 649 observations. In this presentation, we will explore the data by asking questions about key variables to gather insights. From the above output, we see that thre is no missing value in this dataset.

## Data Exploration

```{r overview, fig.align="center", fig.height=8, fig.width=8, warning=FALSE}
devtools::install_github("GuangchuangYu/emojifont") 
library(emojifont)
load.emojifont('OpenSansEmoji.ttf')
require(remoji) 
set.seed(123) 
x <- rnorm(10) 
set.seed(321) 
y <- rnorm(10) 
plot(x, y, cex=0) 
text(x, y, labels=emoji('cow'), cex=1.5, col='steelblue', family='OpenSansEmoji')

dataset$Dalc <- as.factor(dataset$Dalc)      
dataset$Dalc <- mapvalues(dataset$Dalc, 
                              from = 1:5, 
                              to = c("Very Low", "Low", "Medium", "High", "Very High"))

dataset$Walc <- as.factor(dataset$Walc)      
dataset$Walc <- mapvalues(dataset$Walc, 
                              from = 1:5, 
                              to = c("Very Low", "Low", "Medium", "High", "Very High"))

windowsFonts(FontAwesome=windowsFont("FontAwesome"))

alcohol.d <- as.data.frame(table(dataset$Dalc))
par.d <- as.numeric(alcohol.d$Freq)
names(par.d) <- alcohol.d$Var1
par.d <- round(par.d/10)

waffle.col <- c("#00d27f","#adff00","#f9d62e","#fc913a","#ff4e50")

c1 <- waffle(par.d, rows=5, 
             use_glyph="glass", 
             size=2, 
             title = "Workday alcohol consumption among students",
             glyph_size=8,
             xlab="1 glass == 10 students",
             colors=waffle.col,
             legend_pos= "top"
             )

alcohol.w <- as.data.frame(table(dataset$Walc))
par.w <- as.numeric(alcohol.w$Freq)
names(par.w) <- alcohol.w$Var1
par.w <- round(par.w/10)

c2 <- waffle(par.w, rows=5, 
             use_glyph="fa-glass", 
             size=2, 
             title = "Weekend alcohol consumption among students",
             glyph_size=8,
             xlab="1 glass == 10 students",
             colors=waffle.col,
             legend_pos= "top"
             )

grid.arrange(c1,c2, nrow=2)

dataset.d <- dataset
dataset.d %>% mutate(new_column =dataset$Dalc)

p1<- dataset.d %>%
  ggplot(aes(x = Dalc,fill = Dalc))+ 
  geom_bar(position = "dodge")

p2<- dataset.d %>%
  ggplot(aes(x = Walc,fill = Walc))+ 
  geom_bar(position = "dodge")

grid.arrange(p1,p2, nrow=2)

#por$Dalc <- as.factor(por$Dalc)
```




## Age

Using the age of students as a metric , we look at different distributions

### Distribution of Ages of Students depending on workday/weekend Consumption

What are the distribution of ages of students who do and who do not consume alcohol? We will start off with workday consumption followed by weekend consumption.

```{r}
dataset %>%
  ggplot(aes(x=(as.numeric(age))))+
  geom_histogram(fill="green",colour="black",binwidth=1) +
  facet_grid(Dalc ~ .)+
  ggtitle("Distribution based on Age and levels of Workday Consumption")+
  scale_y_continuous(name="Count of Student", limits=c(0, 150))

```

A very small portion of students consume alcohol in a frequent manner on workdays. Is this true of weekend consumption too?


```{r}

ggplot(por, aes(x=(as.numeric(age))))+ geom_histogram(fill="blue", colour="black",binwidth=1) +
facet_grid(Walc ~ .)+ggtitle("Distribution based on Age and levels of Weekend Consumption")


```

We see that more students tend to consume alcohol on higher levels on weekends.

### Distributions of Ages of Students who might(not) be in a romantic relationship



```{r}
ggplot(por, aes(x=(as.numeric(age))))+ geom_histogram(fill="red", colour="black",binwidth=1) +
facet_grid(romantic ~ .)+ggtitle("Distribution based on Age and Whether of not they are in a relationship")

```

Most students who were in a relationship were between the ages of 16-18. Looking at the histograms, we see that a majority of the students were single.

### Health Status

```{r}
ggplot(por, aes(x=(as.numeric(age))))+ geom_histogram(fill="red", colour="black",binwidth=1) +
facet_grid(health ~ .)+ggtitle("Distribution based on Age and Health")

```

Most students were in good health conditions.

## Gender 


### How many female and male students are there?

```{r}
por %>% group_by(sex) %>% summarise(n=n()) %>%
  ggplot(aes(x=sex,y=n))+ geom_bar(stat="identity")


```

The number of female students is higher than the number of male students in this data set.

### How do male and female students consume alcohol?



```{r}

temp <- por %>% group_by(sex,Dalc) %>% summarise(n=n())

ce <- ddply(temp, "sex", transform,
percent = n / sum(n) * 100)
ggplot(ce, aes(x=sex, y=percent, fill=Dalc)) +
geom_bar(stat="identity")
```

A larger percentage of male students consume alcohol frequently on work days as compared to female students. Is this true for weekends as well?


```{r}

temp <- por %>% group_by(sex,Walc) %>% summarise(n=n())
temp$Walc <- as.factor(temp$Walc)

ce <- ddply(temp, "sex", transform,
percent = n / sum(n) * 100)
ggplot(ce, aes(x=sex, y=percent, fill=Walc)) +
geom_bar(stat="identity")
```
 
We see that the percentage of female students that consume alcohol in large amounts go up in the weekends. This is true for male students as well. 
 
### Test Scores

Do test Scores differ for male and female students?


```{r}
library(gridExtra)
df1 <- por %>% select(sex,G1)
p1<-ggplot(por, aes(x=G1)) + geom_histogram(fill="white", colour="black",binwidth=1) +
facet_grid(sex ~ .)+geom_vline(data=aggregate(df1[2], df1[1], median), 
      mapping=aes(xintercept=G1), color="red") 
df2 <- por %>% select(sex,G2)
p2<-ggplot(por, aes(x=G2)) + geom_histogram(fill="blue", colour="black",binwidth = 1) +
facet_grid(sex ~ .)+geom_vline(data=aggregate(df2[2], df2[1], median), 
      mapping=aes(xintercept=G2), color="red") 
df3 <- por %>% select(sex,G3)
p3<-ggplot(por, aes(x=G3)) + geom_histogram(fill="green", colour="black",binwidth = 1) +
facet_grid(sex ~ .)+geom_vline(data=aggregate(df3[2], df3[1], median), 
      mapping=aes(xintercept=G3), color="red") 
grid.arrange(p1,p2,p3)

```

As the distributions are pretty skewed, we take the median of each distribution as the best estimate. According to the plot above, female students have a higher median score compared to male students in all the three testing grades.




## Health and Grades

Are healthier students more likely to score higher on their tests? We use the average of  G1,G2,G3 as our metric

```{r}

por %>% mutate(avg_grade=G3,health=as.factor(health)) %>% group_by(health,sex) %>% summarise(n=mean(avg_grade)) %>%
  ggplot(aes(x=sex,y=n,fill=health))+geom_bar(stat="identity",position = "dodge")+ggtitle("Health and Grades")
```

Students with poor health scored more than the students who had a health score of 5.


## Do romantic relationships affect alcohol consumption?

Let's try looking at workday and weekend consumptions. We test independence using the chi-squared independence test at an alpha level of 0.05.

```{r}
tb1 <- table(por$Walc,por$romantic)
library(MASS)
chisq.test(tb1)

```

The p value being greater than 0.05 implies that these two factors are indeed independent of each other.
What about workday consumption?

```{r}
tb2 <- table(por$Dalc,por$romantic)
chisq.test(tb2)


```


As the p- value is less than 0.05 , we reject the null hypothesis that workday consumption and being/not being in a romantic relationship are independent of each other.


## Do romantic relationships affect grades?

We look at G3(final grade) of the students for comparison 

```{r}

por %>% group_by(romantic) %>% summarise(n=mean(G3,na.rm=T)) %>%
  ggplot(aes(x=romantic,y=n))+geom_bar(stat="identity")


```

According to the data, the mean final grade score(G3) for those who were not in a romantic relationship is greater than those who were.

### How are these scores distributed?

```{r}
 ggplot(por, aes(x=G3, fill=romantic)) +
geom_histogram(position="identity", alpha=0.4,binwidth=1.0)


```

Students who were not in relationships scored higher grades more frequently than those students who were in relationships.

### Does being in a romantic relationship affect female and male students differently?

```{r}
por %>% group_by(sex,romantic) %>% summarise(n=mean(G3,na.rm=T)) %>%
  ggplot(aes(x=sex, y=n, fill=romantic)) +
geom_bar(position="dodge",stat="identity")+ggtitle("Romantic Relationship,Grades and Gender")


```


Female students who were in a relationship performed better than male students in the same situation. In both the genders, those who were not in a romantic relationship performed better on average.


### Are students who are involved in extra curricular activities more likely to be in a romantic relationship?

This was true in my high school. Let's see if this is true here.


```{r}
temp <- por %>% group_by(romantic,activities) %>% summarise(n=n()) 
ce <- ddply(temp, "activities", transform,
percent_weight = n / sum(n) * 100)
ggplot(ce, aes(x=activities, y=percent_weight, fill=romantic)) +
geom_bar(stat="identity")+geom_text(aes(label=percent_weight), vjust=1.5, colour="white",
position=position_dodge(.9), size=3)+ggtitle("Activities and Romantic Relationships")

```

Being involved in extra curricular activities increases your chances of being in a relationship by around 5%.

### Are the percentage increases same for male and female students?

We look at this using two plots.

```{r}
p1<-por %>% filter(sex=="M")%>% group_by(romantic,activities) %>% summarise(n=n()) %>%
  ddply("activities",transform,percent=n/sum(n)*100) %>%
  ggplot(aes(x=activities,y=percent,fill=romantic))+
  geom_bar(stat="identity")+ggtitle("Male Students")+geom_text(aes(label=percent), vjust=1.5, colour="white")

p2<-por %>% filter(sex=="F")%>% group_by(romantic,activities) %>% summarise(n=n()) %>%
  ddply("activities",transform,percent=n/sum(n)*100) %>%
  ggplot(aes(x=activities,y=percent,fill=romantic))+
  geom_bar(stat="identity")+ggtitle("Female Students")+geom_text(aes(label=percent), vjust=1.5, colour="white")

grid.arrange(p1,p2)

```

From the above plots, we see that the percentage increase in being in a romantic relationship increases significantly for male students than compared to female students. This is probably because of the difference in number of male and female students. The number of female students are higher as seen in the previous plot.



### Do the mean number of hours spent studying change for students who are/aren't in relationships?

```{r}

por %>% group_by(romantic) %>% summarise(mean_hour=mean(studytime,na.rm=T)) %>%
  ggplot(aes(x=romantic,y=mean_hour))+geom_bar(stat="identity")+ ggtitle("Mean Number of Hours spent for studying")

```

We see that the difference is little, in fact , students in a romantic relationship spent slightly more time studying on average.


### Are students who go out often, in romantic relationships than those who do not go out often?

According to the data description, the scale with which "going out" measured has a range from very low-1 to very high-5. 


```{r}
por %>% group_by(romantic,goout) %>% summarise(n=n()) %>%
  ddply("goout",transform,percent=n/sum(n)*100) %>%
  ggplot(aes(x=goout,y=percent,fill=romantic))+
  geom_bar(stat="identity")+ggtitle("Percentage of Students of each category who have romantic relationships")


```

We see that amongst students who do not go out much often,a higher percentage of people are involved in romantic relationships which could be counter-intuitive to some.


## Parent's Education


### How does parent's education affect the final grade?

As the distributions are skewed, we take a look at the median scores. We will first start with the mothers' education levels and then move on to the fathers' education levels.

```{r}
ggplot(por, aes(x=G3)) + geom_histogram(fill="green", colour="black",binwidth = 2) +
facet_grid(Medu ~ .)+ggtitle("Mother's education and Final Grades")+geom_vline(data=aggregate(por[33], por[7], median), mapping=aes(xintercept=G3), color="red")

```

We see that as the mother's education level increases, the median G3 grades also increase. Through this plot, we can see that a mother's education level is certainly an important factor for scoring good grades.Does the father's education level carry the same level of importance?

```{r}
ggplot(por, aes(x=G3)) + geom_histogram(fill="green", colour="black",binwidth = 2) +
facet_grid(Fedu ~ .)+ggtitle("Father's education and Final Grades")+geom_vline(data=aggregate(por[33], por[8], median), mapping=aes(xintercept=G3), color="red")



```

We see the same effect of the fathers' education levels as well.

### How does the parent's education level affect the student's decision about higher education?

```{r}
por %>% group_by(Medu,higher) %>% summarise(n=n()) %>%
  ddply("Medu",transform,percent=n/sum(n)*100) %>%
  ggplot(aes(x=Medu,y=percent,fill=higher))+
  geom_bar(stat="identity")+ggtitle("Percentage of students who have plans for higher education vs Mother's Education Levels")

por %>% group_by(Fedu,higher) %>% summarise(n=n()) %>%
  ddply("Fedu",transform,percent=n/sum(n)*100) %>%
  ggplot(aes(x=Fedu,y=percent,fill=higher))+
  geom_bar(stat="identity")+ggtitle("Percentage of students who have plans for higher education vs Father's Education Levels")
```

As the education level of the mother increases, the desire to pursue higher education also increases.For the case of the father's education level, we see that children of fathers who had a low education level tend to have the highest percentage of students who have desires to pursue a higher education which was **different** from the mother's education levels case.


### How does the education level of the parents affect the number of failures faced by the student?

```{r}
por %>% mutate(failures=as.factor(failures))%>% group_by(Medu,failures) %>% summarise(n=n()) %>%
  ddply("Medu",transform,percent=n/sum(n)*100) %>%
  ggplot(aes(x=Medu,y=percent,fill=failures))+
  geom_bar(stat="identity")+ggtitle("Number of failures(%) and education level of the mother")
por %>% mutate(failures=as.factor(failures))%>% group_by(Fedu,failures) %>% summarise(n=n()) %>%
  ddply("Fedu",transform,percent=n/sum(n)*100) %>%
  ggplot(aes(x=Fedu,y=percent,fill=failures))+
  geom_bar(stat="identity")+ggtitle("Number of failures(%) and education level of the father")




```


We see that as the education level of the mother increases, the probability of having zero number of failures also decreases.This is the same for the situation of the father.


### Internet Access and Mother's education level



```{r}
por %>% group_by(Medu,internet) %>% summarise(n=n()) %>%
  ddply("Medu",transform,percent=n/sum(n)*100) %>%
  ggplot(aes(x=Medu,y=percent,fill=internet))+
  geom_bar(stat="identity")+ggtitle("Internet Access(%) and education level of the mother")
por %>% group_by(Fedu,internet) %>% summarise(n=n()) %>%
  ddply("Fedu",transform,percent=n/sum(n)*100) %>%
  ggplot(aes(x=Fedu,y=percent,fill=internet))+
  geom_bar(stat="identity")+ggtitle("Internet Access(%) and education level of the father")
```

As the education level of the mother increases, the probability of students having internet access also increases. We see that the median grades also increase with increase in the mother's education level. In case of the father's education level, percentage **internet access increases until the last level**.

### Does the amount of time spent studying change with the education level of the parents?

```{r}
ggplot(por, aes(x=studytime)) + geom_histogram(fill="blue", colour="black",binwidth = 1) +
facet_grid(Medu ~ .)+ggtitle("Mother's education and  Mean StudyTime")+geom_vline(data=aggregate(por[14], por[7], mean), mapping=aes(xintercept=studytime), color="red")
ggplot(por, aes(x=studytime)) + geom_histogram(fill="blue", colour="black",binwidth = 1) +
facet_grid(Fedu ~ .)+ggtitle("Father's education and  Mean StudyTime")+geom_vline(data=aggregate(por[14], por[8], mean), mapping=aes(xintercept=studytime), color="red")

```

We see that the mean study time increases with the increase the the mother's education level. For the father's case , there is no discernable pattern. In fact, mean study time increases till level 2 of the father's education.

### How does  workday alcohol consumption change with the parent's education level?

```{r}
por %>% group_by(Medu,Dalc) %>% summarise(n=n()) %>%
  ddply("Medu",transform,percent=n/sum(n)*100) %>%
  ggplot(aes(x=Medu,y=percent,fill=Dalc))+
  geom_bar(stat="identity")+ggtitle("Work Day Alcohol Consumption and education level of the mother")

por %>% group_by(Fedu,Dalc) %>% summarise(n=n()) %>%
  ddply("Fedu",transform,percent=n/sum(n)*100) %>%
  ggplot(aes(x=Fedu,y=percent,fill=Dalc))+
  geom_bar(stat="identity")+ggtitle("Work Day Alcohol Consumption and education level of the father")



```

We do not see any pattern here.But for a father who has minimum education, the percentage of students whose daily consumption of alcohol is low, is 100%.


### How about weekend alcohol consumption?

```{r}
por %>%mutate(Walc=as.factor(Walc)) %>% group_by(Medu,Walc) %>% summarise(n=n()) %>%
  ddply("Medu",transform,percent=n/sum(n)*100) %>%
  ggplot(aes(x=Medu,y=percent,fill=Walc))+
  geom_bar(stat="identity")+ggtitle("Weekend Alcohol Consumption and education level of the mother")

por %>%mutate(Walc=as.factor(Walc)) %>% group_by(Fedu,Walc) %>% summarise(n=n()) %>%
  ddply("Fedu",transform,percent=n/sum(n)*100) %>%
  ggplot(aes(x=Fedu,y=percent,fill=Walc))+
  geom_bar(stat="identity")+ggtitle("Weekend Alcohol Consumption and education level of the father")

```

We see that the percentage of students who consume high amounts of alcohol on weekends decreases with the increase in the education level of the mother.But in the case of the father,high levels of alcohol consumption during weekends remain low.The percentage of students who consume high levels of alcohol increases slightly for the highest education level.


### Do parents have the same educational levels?

```{r}
por %>% mutate(if_same=ifelse(Fedu==Medu,"Yes","No")) %>% group_by(if_same) %>% summarise(n=n()) %>%
  ggplot(aes(x=if_same,y=n))+geom_bar(stat="identity")+ggtitle("Number of Parents who have/do not have same educational levels") + geom_text(aes(label=n), vjust=1.5, colour="white")



```

We see that 306 parents do not have the same educational levels.

### Amongst the parents who do not have the same educational levels, how do they differ?

```{r eval=F}
temp_1 <- por %>% mutate(if_less=ifelse(Medu<Fedu,"Less Than","No")) %>% filter(if_less!="No") %>% select(Medu,Fedu,if_less)
temp_2 <- por %>% mutate(if_less=ifelse(Medu>Fedu,"Greater Than","No")) %>% filter(if_less!="No") %>% select(Medu,Fedu,if_less)

temp <- rbind(temp_1,temp_2)

temp %>% group_by(if_less) %>% summarise(n=n()) %>%
  ggplot(aes(x=if_less,y=n)) +geom_bar(stat="identity")+geom_text(aes(label=n), vjust=1.5, colour="white")+ggtitle("Number of Cases where the mother has higher/lower education level")



```




## Predicting the Grades(G3) of students

In this section , we look at the rules to decide whether or not the student scores high/low in their G3 grades. Here, we define _G3>=10_ as a "high".

### Logistic Regression

```{r}
set.seed(2)
por$high <- ifelse(por$G3>=10,1,0)
por$high <- as.factor(por$high)
por <- por[,c(1:32,34)]
por <- por %>% mutate(schoolsup=as.factor(schoolsup),famsup=as.factor(famsup),paid=as.factor(paid),activities=as.factor(activities),nursery=as.factor(nursery),higher=as.factor(higher),internet=as.factor(internet),romantic=as.factor(romantic)) 
train <- sample(dim(por)[1],dim(por)[1]*0.9)
test <- -train
training_data <- por[train,]
testing_data <- por[test,]
log_model <- glm(high~.,data=training_data,family = binomial)
summary(log_model)
predict_log <- predict(log_model,newdata=testing_data,type="response")
predict_log <- round(predict_log)
mean(predict_log==testing_data$high)

```

We have used a set.seed() function to ensure that the samples produced are reproducible. We use the logistic regression predictive model to predict whether the student scores high or low. The output of this model are probabilities that have to be evaluated using a unbiased threshold of 0.5.We see that around 90% of results were classified accurately.

According to the summary of the model, the significant predictors are _G1_,_G2_ and _age_.We need to remember that the model is log scaled to output probabilities. For example, 




### ROC Curve 

We can visualize the model performance using a ROC curve.

```{r}

library(ROCR)
pred <- prediction(predictions = predict_log,labels=testing_data$high)
perf <- performance(pred,measure = "tpr",x.measure = "fpr")

plot(perf,main="ROC Curve for Logistic Regression Model",col="blue",lwd=3)
abline(a=0,b=1,lwd=2,lty=2)

```

### AUC Value

What is the area under the curve?

```{r}

perf.auc <- performance(pred,measure = "auc")
unlist(perf.auc@y.values)


```

The AUC comes to around 0.86 which is not bad! We have a fixed test and training data for the problem. In a real world scenario , the data we deal with are unseen by the model. So how does this model behave when encountered with such a situation?

### Future Performance

To estimate the future performance of the model, we make use of the $Kappa$ statistic.But before that, we divide our dataset into 10-folds to perform a 10-fold cross validation.

```{r}
library(ggplot2)
library(lattice)
library(caret)
library(irr)
library(lpSolve)
set.seed(2)

ctrl <- trainControl(method = "repeatedcv", number = 10, savePredictions = TRUE)

mod_fit <- train(high~.,data=por, method="glm", family="binomial",
                 trControl = ctrl, tuneLength = 5)

pred = predict(mod_fit, newdata=testing_data)
#pred <- round(pred)
kappa2(data.frame(testing_data$high,pred))
 
```

The Kappa value is around 0.83 which indicate  good agreement between the model's prediction and the true values.The model can be improved further by removing predictors that do not contribute to the variability in the results.We could also change the threshold(0.5) value depending on experience.




## Conclusion

By asking a few questions, we were able to understand and get an idea about the data set. There are many other questions to be asked and answered. We could go further by building a predictive model which would allow us to predict the level of consumption of alcohol(or any other response variable) given the input variables(predictors).We saw that the mother's education level was an important factor is determining the student's plans for higher education and his/her grades.



Thank You for reading and please feel free to leave any feedback/suggestions below for further improvement.

